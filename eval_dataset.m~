%% load test set
load ../FLIC/examples.mat
testex = examples([examples.istest]);
ntest = length(testex);
model = loadvar('MODEC-model.mat','mdls');

%% try to replicate paper results DELETE THIS
exampleslr = loadvar('/zain/users/bensapp/data/ps/mpose5K-tbox/examples-cropped.mat');
testex_alt = exampleslr([exampleslr.istest])
%% run MODEC over every test example, saving wrist, elbow and shoulder locations
% pred_coords = nan(2,6,ntest);
for i=60:ntest
    tstart = clock;
    img = imread(fullfile('../FLIC/images/',testex(i).filepath));
    img_alt = imread(testex_alt(i).filepath);
%     pred_i = run_modec(model, img, testex(i).torsobox);
    pred_i = run_modec(model, img_alt);
    pred_coords(:,:,i) = pred_i.coords;
    fprintf('example %d / %d took %s\n',i,ntest,sec2timestr(etime(clock,tstart)));
end
% save results.mat pred_coords
%%
clf
imagesc(img_alt)
hold on
myplot(gt_coords(:,:,60),'yp-')
myplot(pred_coords(:,:,60),'bs-')
%% evaluate
% load results.mat pred_coords
%
% gt_coords = cat(3,testex.coords);
gt_coords = cat(3,testex_alt.coords);

elbow_err = score_predictions(pred_coords, gt_coords, {'lelb','relb'}, {'lsho','rhip'});
wrist_err = score_predictions(pred_coords, gt_coords, {'lwri','rwri'}, {'lsho','rhip'});

%display 
clf
range = 1:20;
accuracyCurve(elbow_err(:),range,'b-','linewidth',3);
hold on
% accuracyCurve(wrist_err(:),range,'m-','linewidth',3)
axis square, grid on
axis([range([1 end]) 1 100])

%% evaluate2
load results.mat pred_coords
%
gt_coords = cat(3,testex.coords);

lelbow_err = score_predictions(pred_coords, gt_coords, {'lelb'}, {'lsho','rhip'});
relbow_err = score_predictions(pred_coords, gt_coords, {'relb'}, {'rhip','lsho'});
elbow_err = [lelbow_err relbow_err];

%display 
clf
range = 1:20;
accuracyCurve(elbow_err(:),range,'b-','linewidth',3);
hold on
% accuracyCurve(wrist_err(:),range,'m-','linewidth',3);
axis square, grid on
axis([range([1 end]) 0 100])
